/*
 * LASER_PCA_AncestryInference — Nextflow config (user-facing template)
 * Replace /path/to/... with your own paths. Keep/adjust defaults as needed.
 */

nextflow.enable.dsl = 2

// ─────────────────────────────────────────────────────────────────────────────
// Parameters (edit these to point to your inputs)
// ─────────────────────────────────────────────────────────────────────────────
params {
  // Reference and Study VCFs (REQUIRED)
  // Expectation: bgzipped + tabix-indexed; one file per chromosome named "chrN.vcf.gz"
  // e.g., /data/ref/gnomad.hgdp_tgp.chr1.vcf.gz ... chr22.vcf.gz (and matching .tbi)
  input_reference = "/path/to/reference/chr*.vcf.gz"
  input_study     =  "/path/to/study/chr*.vcf.gz"

  // Sample include lists (one sample ID per line)
  qc_ref_list     = "/path/to/reference_samples.id"
  qc_study_list   = "/path/to/study_samples.id"

  // If the BED file is included in the repository (e.g., bin/genome_gap_hg38_and_MHC.bed),
  // simply reference it relative to the pipeline directory:
  lowcomplexity_bed = "bin/genome_gap_hg38_and_MHC<_nochr>.bed"  // path relative to main.nf; expects hg38 coordinates and matching <chr> prefix
  header_bed        = "TRUE"                             // set to "FALSE" if the BED file has no header


  // Reference metadata (TSV) used for coloring/labels in plots (columns in this order: `sample     population`)
  meta_file       = "/path/to/reference_metadata.tsv"

  // LASER install directory containing binaries: `laser` and `vcf2geno`
  path_to_laser   = "/path/to/LASER-2.x"

  // Reference genome FASTA (hg38). Can be .fa or .fa.gz if your tools support it.
  ref_fasta       = "/path/to/hg38.fa.gz"

  // ── Defaults (users can override on the CLI) ────────────────────────────────
  // Number of PCs to compute on the reference and used downstream
  nPCs        = 20   // default 20

  // Projection batching: number of study samples per LASER job
  // (A batch of ~1000 typically ~6h; adjust to your cluster/resources)
  batch_size  = 1000

  // KNN-style ancestry call helper params (used by plotting/post-processing)
  k           = 10   // neighbors to consider
  n_pcs       = 4    // PCs to use for the call
  threshold_N = 6    // min neighbors of same ancestry to call


  // Output directory (can be overridden on CLI)
  outdir = "results/LASER_PCA"
}

// ─────────────────────────────────────────────────────────────────────────────
// Process defaults
// ─────────────────────────────────────────────────────────────────────────────
process {
  executor       = "slurm"                  // use "local" for quick tests
  clusterOptions = "--account=<ACCOUNT>"    // ← set your SLURM account
  cpus           = 1
  time           = "1d"
  memory         = "16 GB"

  // (Optional) Containers or Conda (uncomment if you use them)
  // singularity.enabled  = true
  // singularity.autoMounts = true
  // process.container    = 'docker://<org>/<image>:<tag>'
  // conda.enabled        = true
  // conda.cacheDir       = "$HOME/.conda"
}

// ─────────────────────────────────────────────────────────────────────────────
// Per-process overrides
// ─────────────────────────────────────────────────────────────────────────────
process {
  withName: "laser_pca_projection_batch" {
    time   = "16h"
    // If you need to tune resources for projection, uncomment and adjust:
    // cpus   = 1
    // memory = "16 GB"
  }
}

// ─────────────────────────────────────────────────────────────────────────────
// Executors
// ─────────────────────────────────────────────────────────────────────────────
executor {
  $slurm {
    queueSize = 500
    jobName   = { "laser_PCA" }
  }
  $local {
    cpus = 1
  }
}

// ─────────────────────────────────────────────────────────────────────────────
// Helpful notes for users (documentation only)
// - input_reference / input_study must expand to chr1..chr22 .vcf.gz with .tbi
// - sample ID lists are plain text, one ID per line, matching VCF sample names
// - lowcomplexity_bed uses hg38 coordinates; set header_bed accordingly
// - path_to_laser must contain `laser` and `vcf2geno` binaries
// - ref_fasta must match the reference build of your VCFs (hg38/GRCh38)
// - override any param at runtime, e.g.:
//     nextflow run . -c nextflow.config \
//       --input_reference "/ref/chr*.vcf.gz" \
//       --input_study "/study/chr*.vcf.gz" \
//       --nPCs 20 --k 20 --batch_size 1000
// ─────────────────────────────────────────────────────────────────────────────
